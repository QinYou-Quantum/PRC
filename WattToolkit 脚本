// ==UserScript==
// @name         WattToolkit
// @namespace    
// @version      0.01
// @description 不建议取消勾选，会导致某些屎山脚本无法运行，如果是从GitHub上下载的，请将该文件命名为.js文件，谢谢
// @author       Qin_You秦晓尤
// @match        *
// @enable      true
// @grant        Qin_xmlhttpRequest
// @grant        Qin_addStyle
// @grant        Qin_getValue
// @grant        Qin_setValue
// @grant        Qin_log
// ==/UserScript==

var unsafeWindow = this;

function Qin_registerMenuCommand() {

}
function Qin_unregisterMenuCommand() {

}
function Qin_openInTab() {

}
function Qin_notification() {

}
function Qin_setClipboard(val) {
    if (navigator?.clipboard) {
        navigator.clipboard.writeText(val);
    } else {
        const textArea = document.createElement("textarea");
        textArea.value = val;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
    }
}

function Qin_xmlhttpRequest(option) {
    if (String(option) !== '[object Object]') return undefined
    option.method = option.method ? option.method.toUpperCase() : 'GET'
    option.data = option.data || {}
    if (typeof option.data != 'string') {
        var formData = []
        for (var key in option.data) {
            formData.push(''.concat(key, '=', option.data[key]))
        }
        option.data = formData.join('&')
    }
    if (option.method === 'GET' && option.data != null && option.data.length > 0) {
        option.url += location.search.length === 0 ? ''.concat('?', option.data) : ''.concat('&', option.data)
    }
    var url = option.ignoreCros ? option.url : 'https://local.steampp.net/?request=' + encodeURIComponent(option.url);
    option.url = url;
    var xhr = new XMLHttpRequest();
    xhr.timeout = option.timeout;
    xhr.responseType = option.responseType || 'text'
    xhr.onerror = option.onerror;
    xhr.ontimeout = option.ontimeout;
    xhr.open(option.method, option.url, true);
    xhr.setRequestHeader('requestType', 'xhr');
    if (option.headers) {
        Object.keys(option.headers).forEach(function (key) {
            let keyL = key.toLowerCase();
            try {
                if (!option.ignoreCros && HeaderQuery(keyL))
                    xhr.setRequestHeader(keyL + '-steamTool', option.headers[key]);
                else
                    xhr.setRequestHeader(key, option.headers[key]);
            } catch { }
        });
    } else {
        if (option.method === 'POST') {
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        }
    }
    if (option.responseType == 'json') {
        xhr.setRequestHeader('Content-Type', 'application/json; charset=' + document.charset)
    }
    xhr.onload = (e) => {
        console.log(e)
        if (option.onload && typeof option.onload === 'function') {
            option.onload(e.target)
        }
    };
    xhr.send(option.method === 'POST' ? option.data : null)
}
function HeaderQuery(key) {
    switch (key) {
        case 'referer':
            return true;
        case 'cookie':
            return true;
        case 'authorization':
            return true;
        default:
            return false;
    }
}
function Qin_addStyle(css) {
    try {
        let style = document.createElement('style');
        style.textContent = css;
        (document.head || document.body || document.documentElement || document).appendChild(style);
    } catch (e) {
        console.log("Error: env: adding style " + e);
    }
}

function Qin_getValue(name, defaultValue) {
    let value = window.localStorage.getItem(name)
    if (!value) {
        return defaultValue;
    }
    let type = value[0];
    value = value.substring(1);
    switch (type) {
        case 'b':
            return value == 'true';
        case 'n':
            return Number(value);
        case 'o':
            try {
                return JSON.parse(value);
            } catch (e) {
                console.log("Error: env: Qin_getValue " + e);
                return defaultValue;
            }
        default:
            return value;
    }
}

function Qin_setValue(name, value) {
    let type = (typeof value)[0];
    switch (type) {
        case 'o':
            try {
                value = type + JSON.stringify(value);
            } catch (e) {
                console.log("Error: env: Qin_setValue typeof ?Object" + e);
                return;
            }
            break;
        default:
            value = type + value;
    }
    try {
        if (typeof name !== 'string') JSON.stringify(name)
        localStorage.setItem(name, value);
    } catch (e) {
        console.log("Error: env: Qin_setValue saveing" + e);
    }
}

function Qin_log(message) {
    if (window.console) {
        window.console.log(message);
    } else {
        console.log(message);
    }
}

function Qin_listValues() {
    var names = [];
    for (var i = 0, len = localStorage.length; i < len; i++) {
        names.push(localStorage.key(i));
    }
    return names;
}

function onlySteam() {
    var el = document.getElementById('global_actions');
    if (el == null) {
        var box = document.getElementById("footer");
        if (box != null) {
            var html = '<div id="global_actions"><div id="global_action_menu"></div></div>';
            var item = document.createElement('div');
            item.innerHTML = html;
            box.append(item);
        }
    }
}
onlySteam();
